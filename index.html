<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iBasic Promotion Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .btn-tab { 
            background-color: transparent; 
            color: #4b5563;
            transition: all 0.3s ease;
        }
        .btn-tab.active { 
            background: linear-gradient(135deg, #ec4899 0%, #8b5cf6 100%);
            color: white; 
            box-shadow: 0 4px 6px rgba(236, 72, 153, 0.3);
        }
        .notification-toast {
            animation: fadeIn 0.3s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .gradient-bg {
            background: linear-gradient(135deg, #ec4899 0%, #8b5cf6 100%);
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }

        .promo-deleted {
            opacity: 0.5;
            text-decoration: line-through;
            background-color: #f9fafb;
            pointer-events: none;
        }
        .promo-deleted .action-btns {
            pointer-events: auto;
            text-decoration: none;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #ec4899;
            border-radius: 10px;
        }

        /* Timeline Projection Styles */
        .projection-grid {
            display: grid;
            grid-template-columns: 140px repeat(7, 1fr);
            border: 1px solid #e5e7eb;
            background: white;
        }
        .projection-header {
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
            font-size: 9px;
            font-weight: 800;
            text-transform: uppercase;
            color: #6b7280;
            text-align: center;
            padding: 10px 0;
            line-height: 1.2;
        }
        .projection-header.day-col {
            border-right: 1px solid #e5e7eb;
        }
        .projection-row {
            border-bottom: 1px solid #f3f4f6;
            position: relative;
        }
        .promo-bar {
            position: absolute;
            height: 28px;
            top: 10px;
            border-radius: 6px;
            font-size: 8px;
            font-weight: 800;
            color: white;
            display: flex;
            align-items: center;
            padding: 0 8px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .promo-bar:hover {
            transform: scaleY(1.05);
            z-index: 50;
            filter: brightness(1.1);
        }

        @keyframes highlightRow {
            0% { background-color: #fdf2f8; }
            50% { background-color: #fbcfe8; border-color: #ec4899; }
            100% { background-color: transparent; }
        }
        .row-highlight {
            animation: highlightRow 2s ease-out forwards;
        }

        /* Legend styles */
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
            color: #4b5563;
        }
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <header class="gradient-bg text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center">
                <i class="fas fa-store text-3xl mr-3"></i>
                <div>
                    <h1 class="text-2xl font-bold">iBasic Promotion Hub</h1>
                    <p class="text-xs text-pink-100 uppercase tracking-widest">Lingerie & Underwear E-commerce</p>
                </div>
            </div>
            <div class="text-right text-sm font-semibold" id="currentDateTime"></div>
        </div>
    </header>

    <div id="toastContainer" class="fixed top-20 right-4 z-[9999] space-y-2"></div>

    <nav class="container mx-auto mt-6 px-4">
        <div class="bg-white rounded-lg shadow-md p-2 flex gap-2 overflow-x-auto no-scrollbar">
            <button onclick="switchTab('dashboard')" class="btn-tab active px-4 py-2 rounded-lg transition-all whitespace-nowrap">
                <i class="fas fa-chart-line mr-2"></i>Dashboard
            </button>
            <button onclick="switchTab('products')" class="btn-tab px-4 py-2 rounded-lg transition-all whitespace-nowrap">
                <i class="fas fa-box mr-2"></i>Products
            </button>
            <button onclick="switchTab('analysis')" class="btn-tab px-4 py-2 rounded-lg transition-all whitespace-nowrap">
                <i class="fas fa-robot mr-2"></i>AI Insights
            </button>
            <button onclick="switchTab('promotions')" class="btn-tab px-4 py-2 rounded-lg transition-all whitespace-nowrap">
                <i class="fas fa-tags mr-2"></i>Promotions
            </button>
            <button onclick="switchTab('calendar')" class="btn-tab px-4 py-2 rounded-lg transition-all whitespace-nowrap">
                <i class="fas fa-calendar-alt mr-2"></i>Weekly Timeline
            </button>
        </div>
    </nav>

    <main class="container mx-auto mt-6 px-4 pb-12">
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active space-y-6">
            <div id="alertCenter" class="hidden bg-white border-l-4 border-red-500 rounded-lg shadow-sm p-4 alert-pulse">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-bold text-red-700 flex items-center text-sm">
                        <i class="fas fa-exclamation-triangle mr-2"></i>INVENTORY ALERT CENTER
                    </h3>
                    <span id="alertCountBadge" class="bg-red-600 text-white text-[10px] px-2 py-0.5 rounded-full">0 SKUs</span>
                </div>
                <div id="alertList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 max-h-48 overflow-y-auto pr-2"></div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <p class="text-gray-400 text-[10px] font-bold uppercase">Total SKUs</p>
                    <p class="text-3xl font-black text-pink-600" id="totalProducts">0</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <p class="text-gray-400 text-[10px] font-bold uppercase">Total Stock</p>
                    <p class="text-3xl font-black text-purple-600" id="totalStock">0</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <p class="text-gray-400 text-[10px] font-bold uppercase">Sold (L7D)</p>
                    <p class="text-3xl font-black text-orange-500" id="totalSoldL7D">0</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <p class="text-gray-400 text-[10px] font-bold uppercase">Active Campaigns</p>
                    <p class="text-3xl font-black text-green-600" id="activePromotions">0</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="bg-white p-6 rounded-xl shadow-sm border h-[350px]">
                    <h3 class="font-bold mb-4 text-gray-700 text-xs uppercase tracking-wider">Unit Sold by Category</h3>
                    <canvas id="salesByCategoryChart"></canvas>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border h-[350px]">
                    <h3 class="font-bold mb-4 text-gray-700 text-xs uppercase tracking-wider">Top 10 SKUs (Best Sales)</h3>
                    <canvas id="stockVsSalesChart"></canvas>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border h-[350px]">
                    <h3 class="font-bold mb-4 text-red-700 text-xs uppercase tracking-wider">Bottom 10 SKUs (Slowest)</h3>
                    <canvas id="bottomSkusChart"></canvas>
                </div>
            </div>

            <!-- New Dashboard Section: Top Stock by Category -->
            <div class="bg-white p-6 rounded-xl shadow-sm border">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-black text-gray-800 text-sm uppercase tracking-wider flex items-center">
                        <i class="fas fa-warehouse mr-2 text-pink-600"></i>Top 5 SKUs Highest Stock (by Group)
                    </h3>
                    <span class="text-[10px] font-bold text-gray-400 uppercase">Real-time Inventory</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50 border-b">
                            <tr>
                                <th class="px-4 py-3 text-[10px] font-black text-gray-500 uppercase">Category</th>
                                <th class="px-4 py-3 text-[10px] font-black text-gray-500 uppercase">SKU</th>
                                <th class="px-4 py-3 text-[10px] font-black text-gray-500 uppercase">Product Name</th>
                                <th class="px-4 py-3 text-right text-[10px] font-black text-gray-500 uppercase">Current Stock</th>
                                <th class="px-4 py-3 text-right text-[10px] font-black text-gray-500 uppercase">Status</th>
                            </tr>
                        </thead>
                        <tbody id="topStockTableBody" class="divide-y text-xs">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Products Tab -->
        <div id="products" class="tab-content space-y-4">
            <div class="bg-white p-6 rounded-xl shadow-sm border">
                <div class="flex flex-col md:flex-row justify-between gap-4 mb-6">
                    <h2 class="text-xl font-bold text-gray-800">Inventory Management</h2>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="openAddProductModal()" class="gradient-bg text-white px-4 py-2 rounded-lg font-bold shadow hover:opacity-90">
                            <i class="fas fa-plus mr-1"></i>Add SKU
                        </button>
                        <button onclick="downloadSampleCSV()" class="bg-amber-500 text-white px-4 py-2 rounded-lg font-bold shadow hover:bg-amber-600 transition">
                            <i class="fas fa-file-download mr-1"></i>Sample CSV
                        </button>
                        <label class="bg-green-600 text-white px-4 py-2 rounded-lg font-bold shadow cursor-pointer hover:bg-green-700 transition">
                            <i class="fas fa-file-import mr-1"></i>Import CSV
                            <input type="file" accept=".csv" class="hidden" onchange="handleFileImport(event)">
                        </label>
                        <button onclick="exportProductsToExcel()" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold shadow">
                            <i class="fas fa-download mr-1"></i>Export CSV
                        </button>
                        <button onclick="confirmDeleteAllProducts()" class="bg-red-500 text-white px-4 py-2 rounded-lg font-bold shadow">
                            <i class="fas fa-trash-alt mr-1"></i>Delete All
                        </button>
                    </div>
                </div>
                <div class="flex gap-4 mb-4">
                    <input type="text" id="searchProduct" onkeyup="renderProducts()" placeholder="Search by SKU or name..." class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-pink-500 outline-none">
                    <select id="filterCategory" onchange="renderProducts()" class="px-4 py-2 border rounded-lg outline-none">
                        <option value="">All Categories</option>
                    </select>
                    <select id="filterStatus" onchange="renderProducts()" class="px-4 py-2 border rounded-lg outline-none">
                        <option value="">All Statuses</option>
                        <option value="Active">Active</option>
                        <option value="New Arrival">New Arrival</option>
                        <option value="Discontinued">Discontinued</option>
                    </select>
                </div>
                <div class="overflow-x-auto rounded-lg border">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50 border-b">
                            <tr>
                                <th class="px-4 py-3 text-left font-bold text-gray-500 uppercase">SKU</th>
                                <th class="px-4 py-3 text-left font-bold text-gray-500 uppercase">Product Name</th>
                                <th class="px-4 py-3 text-left font-bold text-gray-500 uppercase text-center">Status</th>
                                <th class="px-4 py-3 text-left font-bold text-gray-500 uppercase">Category</th>
                                <th class="px-4 py-3 text-right font-bold text-gray-500 uppercase">Stock</th>
                                <th class="px-4 py-3 text-right font-bold text-gray-500 uppercase">Sold (L7D)</th>
                                <th class="px-4 py-3 text-right font-bold text-gray-500 uppercase">Price</th>
                                <th class="px-4 py-3 text-center font-bold text-gray-500 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="productsTableBody" class="divide-y"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- AI Insights Tab -->
        <div id="analysis" class="tab-content space-y-6">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-pink-100">
                <div class="flex flex-col md:flex-row items-center justify-between gap-6 mb-8 border-b border-pink-50 pb-6">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 rounded-2xl gradient-bg flex items-center justify-center text-white shadow-lg">
                            <i class="fas fa-robot text-3xl"></i>
                        </div>
                        <div>
                            <h2 class="text-2xl font-black text-gray-800">iBasic AI Strategy Lab</h2>
                            <p class="text-xs text-gray-500 mt-1 uppercase tracking-wider font-bold">Ecommerce Growth Strategy Engine</p>
                        </div>
                    </div>
                    <div class="flex flex-col gap-2 w-full md:w-auto">
                        <div class="flex gap-2">
                            <input type="password" id="geminiApiKey" placeholder="Enter Gemini API Key..." class="flex-1 md:w-64 px-4 py-2 border rounded-xl text-xs outline-none focus:ring-2 focus:ring-pink-500">
                            <button onclick="saveApiKey()" class="bg-gray-800 text-white px-4 py-2 rounded-xl text-xs font-bold hover:bg-black transition shadow">Save</button>
                        </div>
                        
                        <div class="flex gap-2">
                            <select id="aiChannelSelect" class="flex-1 md:w-48 px-4 py-2 border rounded-xl text-xs outline-none focus:ring-2 focus:ring-pink-500 font-bold">
                                <option value="All Channels">üåê Ph√¢n t√≠ch T·∫•t c·∫£ k√™nh</option>
                                <option value="Shopee/Lazada">üõí Shopee/Lazada</option>
                                <option value="Tiktok Shop">üéµ Tiktok Shop</option>
                                <option value="Website">üè† Official Website</option>
                                <option value="Tiki">üì¶ Tiki</option>
                            </select>
                            <button onclick="analyzeProductsWithGemini()" id="aiGenerateBtn" class="flex-1 gradient-bg text-white py-2 px-6 rounded-xl font-black text-xs shadow-xl hover:scale-[1.02] active:scale-95 transition">
                                <i class="fas fa-bolt mr-2"></i>GENERATE AI STRATEGY
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="analysisResults" class="min-h-[400px] bg-white rounded-2xl p-0 overflow-hidden border">
                    <div class="flex flex-col items-center justify-center py-24 text-gray-400 space-y-4">
                        <i class="fas fa-chart-pie text-5xl opacity-20"></i>
                        <p class="font-bold text-center text-sm">Ch·ªçn k√™nh v√† nh·∫•n n√∫t ph√≠a tr√™n ƒë·ªÉ b·∫Øt ƒë·∫ßu ph√¢n t√≠ch AI chuy√™n s√¢u.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Manage Promos Tab -->
        <div id="promotions" class="tab-content space-y-4">
            <div class="bg-white p-6 rounded-xl shadow-sm border">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                    <h2 class="text-xl font-bold text-gray-800">Promotion Management</h2>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="confirmDeleteAllPromotions()" class="bg-gray-100 text-red-600 px-4 py-2 rounded-lg font-bold border border-red-200 hover:bg-red-50 transition">
                            <i class="fas fa-trash-alt mr-1"></i>Delete All
                        </button>
                        <button onclick="exportPromotionsToCSV()" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold shadow hover:bg-blue-700 transition">
                            <i class="fas fa-download mr-1"></i>Export CSV
                        </button>
                        <button onclick="openAddPromotionModal()" class="bg-green-600 text-white px-6 py-2 rounded-lg font-bold shadow hover:bg-green-700 transition">
                            <i class="fas fa-plus mr-1"></i>New Campaign
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-5 gap-3 mb-6 bg-gray-50 p-4 rounded-xl border">
                    <div class="md:col-span-2">
                        <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Search Name / SKU</label>
                        <input type="text" id="promoFilterSearch" onkeyup="renderPromotions()" placeholder="Search name or SKU..." class="w-full px-4 py-2 border rounded-lg text-sm outline-none focus:ring-2 focus:ring-pink-500">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Tool Group</label>
                        <select id="promoFilterTool" onchange="renderPromotions()" class="w-full px-3 py-2 border rounded-lg text-sm outline-none">
                            <option value="">All Tools</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Campaign Type</label>
                        <select id="promoFilterType" onchange="renderPromotions()" class="w-full px-3 py-2 border rounded-lg text-sm outline-none">
                            <option value="">All Types</option>
                            <option value="DDay">DDay</option>
                            <option value="BAU">BAU</option>
                            <option value="Weekend">Weekend</option>
                            <option value="Special Day">Special Day</option>
                            <option value="15th">15th</option>
                            <option value="25th">25th</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Status</label>
                        <select id="promoFilterStatus" onchange="renderPromotions()" class="w-full px-3 py-2 border rounded-lg text-sm outline-none">
                            <option value="all">All</option>
                            <option value="active" selected>Active</option>
                            <option value="deleted">Soft Deleted</option>
                        </select>
                    </div>
                </div>

                <div class="overflow-x-auto border rounded-lg">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50 border-b">
                            <tr>
                                <th class="px-4 py-3 text-left font-bold text-gray-500 uppercase">Program Name</th>
                                <th class="px-4 py-3 text-left font-bold text-gray-500 uppercase">Target SKUs</th>
                                <th class="px-4 py-3 text-center font-bold text-gray-500 uppercase">Type</th>
                                <th class="px-4 py-3 text-center font-bold text-gray-500 uppercase">Tool</th>
                                <th class="px-4 py-3 text-left font-bold text-gray-500 uppercase w-48">Offer Mechanics</th>
                                <th class="px-4 py-3 text-left font-bold text-gray-500 uppercase">Duration</th>
                                <th class="px-4 py-3 text-center font-bold text-gray-500 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="promotionsTableBody" class="divide-y"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Weekly Promotion Timeline Tab -->
        <div id="calendar" class="tab-content">
            <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100">
                <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-6 mb-8">
                    <div>
                        <h2 class="text-2xl font-black text-gray-800">Strategic Timeline Projection</h2>
                        <p class="text-xs text-gray-400 uppercase tracking-widest font-bold mt-1">Detailed Weekly Promotion Schedule</p>
                    </div>
                    
                    <div class="flex items-center gap-4 bg-gray-50 p-4 rounded-2xl border w-full lg:w-auto">
                        <div class="flex flex-col">
                            <label class="text-[10px] font-bold text-gray-400 uppercase mb-1">Select Year</label>
                            <select id="timelineYearSelect" onchange="renderWeeklyTimeline()" class="px-3 py-2 border rounded-xl text-xs font-black bg-white text-pink-600">
                                <option value="2025">2025</option>
                                <option value="2026" selected>2026</option>
                                <option value="2027">2027</option>
                                <option value="2028">2028</option>
                                <option value="2029">2029</option>
                                <option value="2030">2030</option>
                                <option value="2031">2031</option>
                            </select>
                        </div>
                        <div class="flex flex-col">
                            <label class="text-[10px] font-bold text-gray-400 uppercase mb-1">View From Week</label>
                            <div class="flex items-center gap-2">
                                <input type="number" id="viewStartWeek" value="1" min="1" max="52" onchange="renderWeeklyTimeline()" class="w-14 px-2 py-2 border rounded-xl text-xs text-center font-bold outline-none">
                                <span class="text-gray-300">-</span>
                                <input type="number" id="viewEndWeek" value="12" min="1" max="52" onchange="renderWeeklyTimeline()" class="w-14 px-2 py-2 border rounded-xl text-xs text-center font-bold outline-none">
                            </div>
                        </div>
                        <button onclick="downloadSelectedWeeksCSV()" class="ml-auto lg:ml-4 bg-blue-600 text-white px-6 py-3 rounded-xl text-xs font-black shadow-lg hover:bg-blue-700 transition flex items-center">
                            <i class="fas fa-file-download mr-2"></i>DOWNLOAD PIVOT REPORT
                        </button>
                    </div>
                </div>

                <!-- Legend / Ghi ch√∫ m√†u s·∫Øc -->
                <div class="flex flex-wrap gap-4 mb-6 p-4 bg-gray-50 rounded-xl border border-dashed border-gray-200">
                    <span class="text-[10px] font-black text-gray-400 uppercase w-full mb-1">K√™nh b√°n h√†ng:</span>
                    <div class="legend-item"><div class="legend-color bg-orange-500"></div>Shopee/Laz</div>
                    <div class="legend-item"><div class="legend-color bg-cyan-400"></div>Tiktok Shop</div>
                    <div class="legend-item"><div class="legend-color bg-black"></div>Official Web</div>
                    <div class="legend-item"><div class="legend-color bg-blue-600"></div>Tiki</div>
                    <div class="legend-item"><div class="legend-color bg-pink-500"></div>Other</div>
                </div>

                <!-- Timeline Container -->
                <div id="calendarView" class="space-y-12 max-h-[1000px] overflow-y-auto pr-4 custom-scrollbar pb-20">
                    <!-- Projection Weeks Populated Here -->
                </div>
            </div>
        </div>
    </main>

    <footer class="container mx-auto px-4 py-8 mt-12 border-t border-gray-200">
        <div class="text-center text-gray-400 text-xs font-bold uppercase tracking-widest">
            <p>Copyright by Tien Hoang 2025</p>
        </div>
    </footer>

    <!-- Modal: Confirm Delete -->
    <div id="confirmModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden flex items-center justify-center z-[200]">
        <div class="bg-white w-full max-sm rounded-2xl shadow-2xl p-6 text-center">
            <div class="w-16 h-16 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-exclamation-circle text-3xl"></i>
            </div>
            <h3 class="text-lg font-black text-gray-800 mb-2">Confirmation</h3>
            <p id="confirmModalText" class="text-sm text-gray-500 mb-6">This action cannot be undone.</p>
            <div class="flex gap-3">
                <button onclick="closeConfirmModal()" class="flex-1 py-2 bg-gray-100 font-bold rounded-xl text-gray-500">Cancel</button>
                <button id="confirmBtn" class="flex-1 py-2 bg-red-600 text-white font-bold rounded-xl shadow-lg hover:bg-red-700 transition">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Modal: Add/Edit Product -->
    <div id="addProductModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden flex items-center justify-center z-[100]">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl p-8">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-black text-gray-800" id="productModalTitle">Add New Product</h3>
                <button onclick="closeAddProductModal()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            </div>
            <form id="addProductForm" onsubmit="submitProduct(event)" class="space-y-4">
                <input type="hidden" name="id" id="productIdToEdit">
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2">
                        <label class="block text-[10px] font-bold uppercase text-gray-400 mb-1">Product Name *</label>
                        <input type="text" name="name" required class="w-full px-4 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-pink-500">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold uppercase text-gray-400 mb-1">SKU ID *</label>
                        <input type="text" name="sku" required class="w-full px-4 py-2 border rounded-lg outline-none focus:ring-2 focus:ring-pink-500">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold uppercase text-gray-400 mb-1">Status *</label>
                        <select name="status" id="productFormStatus" required class="w-full px-4 py-2 border rounded-lg outline-none">
                            <option value="Active">Active</option>
                            <option value="New Arrival">New Arrival</option>
                            <option value="Discontinued">Discontinued</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold uppercase text-gray-400 mb-1">Category *</label>
                        <input type="text" name="category" list="categoryDatalist" required class="w-full px-4 py-2 border rounded-lg outline-none">
                        <datalist id="categoryDatalist"></datalist>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold uppercase text-gray-400 mb-1">Stock Quantity *</label>
                        <input type="number" name="stock_quantity" required min="0" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold uppercase text-gray-400 mb-1">Unit Price (VND) *</label>
                        <input type="number" name="unit_price" required min="0" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                </div>
                <div class="flex gap-3 pt-6">
                    <button type="button" onclick="closeAddProductModal()" class="flex-1 py-3 bg-gray-100 font-bold rounded-xl text-gray-500">Cancel</button>
                    <button type="submit" class="flex-1 py-3 gradient-bg text-white font-bold rounded-xl shadow-lg">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Strategic Promotion Designer -->
    <div id="addPromotionModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden flex items-center justify-center z-[100]">
        <div class="bg-white w-[95%] max-w-6xl rounded-3xl shadow-2xl p-8 max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-black mb-8 text-green-700 flex items-center">
                <i class="fas fa-magic mr-3"></i>Strategic Promotion Designer
            </h3>
            <form id="addPromotionForm" onsubmit="submitPromotion(event)" class="grid grid-cols-1 lg:grid-cols-3 gap-10">
                <input type="hidden" name="promo_id" id="promoIdToEdit">
                <div class="space-y-6">
                    <div>
                        <h4 class="font-bold border-b pb-2 text-pink-600 mb-4 flex justify-between items-center text-sm">
                            1. Select Targets
                            <span id="selectedCount" class="text-[10px] bg-pink-100 px-2 py-1 rounded-full text-pink-700">0 Selected</span>
                        </h4>
                        
                        <div class="space-y-4">
                            <div id="overlapAlertBox" class="hidden bg-blue-50 border border-blue-200 rounded-xl p-4 shadow-sm">
                                <p class="text-[11px] font-black text-blue-700 uppercase flex items-center mb-3">
                                    <i class="fas fa-info-circle mr-2 text-lg"></i>Note: SKU already in another Campaign
                                </p>
                                <div id="overlappingPromosList" class="space-y-2"></div>
                            </div>
                            <div class="bg-gray-50 p-3 rounded-xl border border-dashed">
                                <p class="text-[10px] font-bold text-gray-400 uppercase mb-2">Select by Category</p>
                                <div id="categoryCheckboxList" class="space-y-1"></div>
                            </div>
                            <div class="bg-gray-50 p-3 rounded-xl border border-dashed">
                                <p class="text-[10px] font-bold text-gray-400 uppercase mb-2">Select by Product Name</p>
                                <input type="text" id="modalNameSearch" onkeyup="searchNamesInModal()" placeholder="Search product name..." class="w-full px-3 py-1.5 border rounded-lg mb-2 outline-none text-[10px] font-medium">
                                <div id="nameGroupCheckboxList" class="space-y-1 max-h-40 overflow-y-auto pr-1"></div>
                            </div>
                            <div>
                                <p class="text-[10px] font-bold text-gray-400 uppercase mb-2">Select Individual SKUs</p>
                                <input type="text" id="modalProductSearch" onkeyup="searchProductsInModal()" placeholder="Filter SKUs..." class="w-full px-4 py-2 border rounded-lg mb-4 outline-none text-sm">
                                <div class="max-h-60 overflow-y-auto border rounded-xl p-3 space-y-1 bg-white" id="productCheckboxList"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="lg:border-x px-4 space-y-6">
                    <h4 class="font-bold border-b pb-2 text-pink-600 mb-4 text-center text-sm">2. Configure Deal</h4>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-[10px] font-bold text-gray-400 uppercase">Program Name *</label>
                            <input type="text" name="promotion_name" id="promoFormName" required placeholder="e.g., Year End Clearance" class="w-full px-4 py-2 border rounded-lg outline-none font-bold focus:ring-2 focus:ring-green-500">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-400 uppercase">Campaign Type</label>
                            <select name="promotion_type" id="promoFormType" required class="w-full px-4 py-2 border rounded-lg outline-none font-bold">
                                <option value="DDay">üî¥ DDay</option>
                                <option value="BAU">üîµ BAU</option>
                                <option value="Weekend">üü¢ Weekend</option>
                                <option value="Special Day">üü° Special Day</option>
                                <option value="15th">üü£ 15th</option>
                                <option value="25th">üîµ 25th</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-400 uppercase">Execution Tool</label>
                            <select name="promotion_tool" id="promoToolSelect" required class="w-full px-4 py-2 border rounded-lg outline-none font-bold"></select>
                        </div>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-[10px] font-bold text-gray-400 uppercase">Start Date</label>
                                <input type="datetime-local" name="start_date" id="promoFormStart" required class="w-full px-3 py-2 border rounded-lg text-sm">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-gray-400 uppercase">End Date</label>
                                <input type="datetime-local" name="end_date" id="promoFormEnd" required class="w-full px-3 py-2 border rounded-lg text-sm">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="space-y-6">
                    <h4 class="font-bold border-b pb-2 text-pink-600 mb-4 text-sm">3. Execution Details</h4>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-[10px] font-bold text-gray-400 uppercase">Applied Channel</label>
                            <select name="channel" id="promoFormChannel" class="w-full px-4 py-2 border rounded-lg font-medium">
                                <option value="Website">üåê Official Website</option>
                                <option value="Shopee/Lazada">üõí Shopee/Lazada</option>
                                <option value="Tiktok Shop">üéµ Tiktok Shop</option>
                                <option value="Tiki">üì¶ Tiki</option>
                                <option value="Other">‚ûï Other</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-400 uppercase">Detailed Mechanics</label>
                            <textarea name="details" id="promoFormDetails" class="w-full px-4 py-2 border rounded-lg h-32 outline-none text-sm" placeholder="e.g., Buy 1 Get 1, 50% off for orders over 500k..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-3 flex gap-4 pt-6 border-t mt-4">
                    <button type="button" onclick="closeAddPromotionModal()" class="px-10 py-3 bg-gray-100 font-bold rounded-xl text-gray-500">Close</button>
                    <button type="submit" id="promoSubmitBtn" class="flex-1 py-4 bg-green-600 text-white font-black rounded-xl shadow-lg hover:bg-green-700 transition transform active:scale-95 uppercase">Launch Campaign Now</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- DATA STATE ---
        let products = [];
        let promotions = [];
        
        // --- UPDATED EXECUTION TOOLS ---
        const PROMOTION_TOOLS = {
            cross_selling: [
                "Combo Bundle (Mua theo b·ªô)", 
                "Frequently Bought Together (G·ª£i √Ω mua k√®m t·ª± ƒë·ªông)", 
                "Free Gift (Qu√† t·∫∑ng theo ƒë∆°n h√†ng)", 
                "Add-on Deals (Mua k√®m gi√° s·ªëc)", 
                "Voucher (M√£ gi·∫£m gi√°)", 
                "Progressive Freeship (Thanh ti·∫øn ƒë·ªô mi·ªÖn ph√≠ ship)"
            ],
            push_sales: [
                "Flash Sale Countdown (Gi·∫£m gi√° ch·ªõp nho√°ng)", 
                "Quantity Discount (Mua nhi·ªÅu gi·∫£m s√¢u)", 
                "First-order Bonus (∆Øu ƒë√£i ƒë∆°n h√†ng ƒë·∫ßu ti√™n)", 
                "Inventory Clearance (ƒê·ªìng gi√° x·∫£ kho)", 
                "Limited Edition Tag (Nh√£n gi·ªõi h·∫°n s·ªë l∆∞·ª£ng)", 
                "Early Bird Special (∆Øu ƒë√£i mua s·ªõm)", 
                "Happy Hours (Gi·ªù v√†ng gi·∫£m gi√°)"
            ],
            livestream: [
                "Livestream Exclusive Voucher (M√£ ƒë·ªôc quy·ªÅn Live)", 
                "Auction Style (ƒê·∫•u gi√° s·∫£n ph·∫©m)", 
                "Milestone Giveaway (T·∫∑ng qu√† theo t∆∞∆°ng t√°c)", 
                "Lucky Draw/Random Picker (V√≤ng quay may m·∫Øn)", 
                "Comment-to-Buy (Ch·ªët ƒë∆°n qua b√¨nh lu·∫≠n)", 
                "Follow-the-Live Bonus (T·∫∑ng qu√† follower m·ªõi)"
            ],
            membership: [
                "Tiered Membership (Ph√¢n h·∫°ng h·ªôi vi√™n)", 
                "Point Gift (T√≠ch ƒëi·ªÉm ƒë·ªïi qu√†)", 
                "Member-Only Prices (Gi√° ƒë·ªôc quy·ªÅn theo h·∫°ng)", 
                "Birthday Month Special (∆Øu ƒë√£i sinh nh·∫≠t)", 
                "Welcome Gift (Qu√† t·∫∑ng ƒëƒÉng k√Ω m·ªõi)", 
                "Referral Program (Gi·ªõi thi·ªáu b·∫°n b√®)", 
                "Early Access (ƒê·∫∑c quy·ªÅn mua s·ªõm)"
            ]
        };

        let GEMINI_API_KEY = localStorage.getItem('ib_gemini_key') || '';
        let sChart, stChart, botChart; 

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            initUI();
            updateDashboard();
            renderProducts();
            renderPromotions();
            
            if(GEMINI_API_KEY) {
                const apiInput = document.getElementById('geminiApiKey');
                if (apiInput) apiInput.value = GEMINI_API_KEY;
            }
            setInterval(() => {
                const dateEl = document.getElementById('currentDateTime');
                if (dateEl) dateEl.textContent = new Date().toLocaleString('en-US');
            }, 1000);
        });

        function loadData() {
            const p = localStorage.getItem('ib_products');
            const pr = localStorage.getItem('ib_promos');
            if(p) products = JSON.parse(p);
            else loadSampleData();
            if(pr) promotions = JSON.parse(pr);
            products.forEach(prod => { if(!prod.status) prod.status = "Active"; });
        }

        function saveData() {
            localStorage.setItem('ib_products', JSON.stringify(products));
            localStorage.setItem('ib_promos', JSON.stringify(promotions));
        }

        function loadSampleData() {
            products = [
                { id: 1, sku: 'BRA-889', name: 'Luxury Lace Push-up', category: 'Bra', stock_quantity: 450, unit_price: 349000, sold_l7d: 12, status: 'Active' },
                { id: 2, sku: 'PAN-012', name: 'Seamless Daily Pantie', category: 'Pantie', stock_quantity: 1200, unit_price: 89000, sold_l7d: 155, status: 'Active' },
                { id: 3, sku: 'MEN-003', name: 'Modal Boxer Brief', category: 'Men Wear', stock_quantity: 45, unit_price: 159000, sold_l7d: 35, status: 'New Arrival' },
                { id: 4, sku: 'KID-001', name: 'Cotton Kids Tee', category: 'Kids', stock_quantity: 200, unit_price: 129000, sold_l7d: 5, status: 'Active' }
            ];
            saveData();
        }

        function getUniqueCategories() {
            return [...new Set(products.map(p => p.category))].filter(c => c).sort();
        }

        function initUI() {
            const tSel = document.getElementById('promoToolSelect');
            const fTool = document.getElementById('promoFilterTool');
            let toolsHtml = '';
            let filterToolsHtml = '<option value="">All Tools</option>';
            
            const groupLabels = { 
                cross_selling: "üì¶ CROSS-SELLING & AOV", 
                push_sales: "üöÄ PUSH SALES & URGENCY", 
                livestream: "üé• LIVESTREAM PROMO", 
                membership: "üíé MEMBERSHIP LOYALTY" 
            };
            
            for(let key in PROMOTION_TOOLS) {
                toolsHtml += `<optgroup label="${groupLabels[key] || key.toUpperCase()}">`;
                PROMOTION_TOOLS[key].forEach(t => { 
                    toolsHtml += `<option value="${t}">${t}</option>`; 
                    filterToolsHtml += `<option value="${t}">${t.split(' (')[0]}</option>`; 
                });
                toolsHtml += `</optgroup>`;
            }
            if (tSel) tSel.innerHTML = toolsHtml;
            if (fTool) fTool.innerHTML = filterToolsHtml;
            updateCategoryUI();
        }

        function updateCategoryUI() {
            const cats = getUniqueCategories();
            const fCat = document.getElementById('filterCategory');
            if (fCat) { fCat.innerHTML = '<option value="">All Categories</option>' + cats.map(c => `<option value="${c}">${c}</option>`).join(''); }
            const datalist = document.getElementById('categoryDatalist');
            if (datalist) { datalist.innerHTML = cats.map(c => `<option value="${c}">`).join(''); }
        }

        function showConfirmModal(text, onConfirm) {
            document.getElementById('confirmModalText').textContent = text;
            document.getElementById('confirmModal').classList.remove('hidden');
            document.getElementById('confirmBtn').onclick = () => { onConfirm(); closeConfirmModal(); };
        }
        function closeConfirmModal() { document.getElementById('confirmModal').classList.add('hidden'); }

        function getStatusBadge(status) {
            switch(status) {
                case 'New Arrival': return '<span class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full text-[9px] font-black uppercase border border-blue-200">New Arrival</span>';
                case 'Discontinued': return '<span class="bg-gray-100 text-gray-500 px-2 py-0.5 rounded-full text-[9px] font-black uppercase border border-gray-200">Discontinued</span>';
                default: return '<span class="bg-green-100 text-green-700 px-2 py-0.5 rounded-full text-[9px] font-black uppercase border border-green-200">Active</span>';
            }
        }

        function getChannelColorClass(channel) {
            switch(channel) {
                case 'Shopee/Lazada': return 'bg-orange-500';
                case 'Tiktok Shop': return 'bg-cyan-400';
                case 'Website': return 'bg-black';
                case 'Tiki': return 'bg-blue-600';
                case 'Other': return 'bg-pink-500';
                default: return 'bg-gray-500';
            }
        }

        function getPromoTypeClasses(type) {
            switch(type) {
                case 'DDay': return 'bg-red-500';
                case 'Weekend': return 'bg-green-500';
                case 'BAU': return 'bg-blue-500';
                case 'Special Day': return 'bg-amber-500';
                case '15th': return 'bg-purple-500';
                case '25th': return 'bg-indigo-500';
                default: return 'bg-gray-500';
            }
        }

        // --- DASHBOARD ---
        function updateDashboard() {
            document.getElementById('totalProducts').textContent = products.length;
            document.getElementById('totalStock').textContent = products.reduce((s, p) => s + p.stock_quantity, 0).toLocaleString();
            document.getElementById('totalSoldL7D').textContent = products.reduce((s, p) => s + p.sold_l7d, 0).toLocaleString();
            document.getElementById('activePromotions').textContent = promotions.filter(p => !p.deleted).length;
            checkStockAlerts();
            renderCharts();
            renderTopStockDashboard();
        }

        function checkStockAlerts() {
            const criticalSkus = products.filter(p => { 
                if(p.status === 'Discontinued') return false;
                const ratio = p.sold_l7d > 0 ? (p.stock_quantity / p.sold_l7d) : 999; 
                return ratio > 15 || ratio < 2; 
            });
            const alertCenter = document.getElementById('alertCenter');
            if(criticalSkus.length === 0) { alertCenter.classList.add('hidden'); return; }
            alertCenter.classList.remove('hidden');
            document.getElementById('alertCountBadge').textContent = `${criticalSkus.length} SKU(s)`;
            document.getElementById('alertList').innerHTML = criticalSkus.map(p => {
                const ratio = p.sold_l7d > 0 ? (p.stock_quantity / p.sold_l7d) : 999;
                return `<div class="p-2 border rounded flex items-center justify-between text-xs bg-gray-50"><div><span class="font-bold text-xs">${p.sku}</span><p class="text-[9px] text-gray-400 truncate w-32">${p.name}</p></div><div class="text-right"><span class="${ratio > 15 ? 'text-red-600' : 'text-orange-600'} font-black text-[9px] uppercase tracking-tighter">${ratio > 15 ? 'Overstock' : 'Low Stock'}</span></div></div>`;
            }).join('');
        }

        // --- TOP STOCK DASHBOARD ---
        function renderTopStockDashboard() {
            const container = document.getElementById('topStockTableBody');
            if(!container) return;

            // Get Top 5 by Stock Quantity
            const topStock = [...products].sort((a, b) => b.stock_quantity - a.stock_quantity).slice(0, 5);

            container.innerHTML = topStock.map(p => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3">
                        <span class="bg-gray-100 text-gray-600 px-2 py-0.5 rounded text-[9px] font-black uppercase">${p.category}</span>
                    </td>
                    <td class="px-4 py-3 font-mono font-bold text-blue-600 text-[10px] whitespace-normal break-all">${p.sku}</td>
                    <td class="px-4 py-3 font-medium text-gray-700 whitespace-normal break-words">${p.name}</td>
                    <td class="px-4 py-3 text-right">
                        <span class="font-black text-pink-600">${p.stock_quantity.toLocaleString()}</span>
                    </td>
                    <td class="px-4 py-3 text-right">
                        ${getStatusBadge(p.status)}
                    </td>
                </tr>
            `).join('');

            if(topStock.length === 0) {
                container.innerHTML = `<tr><td colspan="5" class="py-10 text-center text-gray-400 font-bold italic">No data available</td></tr>`;
            }
        }

        // --- AI ANALYTICS ---
        async function analyzeProductsWithGemini() {
            if(!GEMINI_API_KEY) return showNotification("API Key Required!", "error");
            const output = document.getElementById('analysisResults');
            const btn = document.getElementById('aiGenerateBtn');
            const selectedChannel = document.getElementById('aiChannelSelect').value;
            
            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>ANALYZING...`;
            
            output.innerHTML = `
                <div class="flex flex-col items-center justify-center py-32 text-pink-500 bg-gray-50">
                    <div class="relative mb-8">
                        <i class="fas fa-brain text-7xl animate-pulse"></i>
                        <i class="fas fa-bolt absolute -top-2 -right-2 text-yellow-400 text-2xl animate-bounce"></i>
                    </div>
                    <p class="text-xs text-gray-400 mt-2 font-bold uppercase tracking-widest">ƒêang x√¢y d·ª±ng chi·∫øn l∆∞·ª£c cho k√™nh ${selectedChannel}...</p>
                </div>`;

            const now = new Date();
            const startOfYear = new Date(now.getFullYear(), 0, 1);
            const pastDaysOfYear = (now - startOfYear) / 86400000;
            const currentWeek = Math.ceil((pastDaysOfYear + startOfYear.getDay() + 1) / 7);
            const currentMonth = now.getMonth() + 1;

            const dataForAI = products.map(p => ({ 
                sku: p.sku, 
                name: p.name, 
                category: p.category, 
                stock: p.stock_quantity, 
                sales_l7d: p.sold_l7d, 
                list_price: p.unit_price, 
                status: p.status,
                stock_weeks: p.sold_l7d > 0 ? (p.stock_quantity / p.sold_l7d).toFixed(1) : 'High'
            }));

            const activePromosForAI = promotions
                .filter(p => !p.deleted)
                .map(p => ({
                    name: p.promotion_name, type: p.promotion_type, tool: p.promotion_tool, channel: p.channel,
                    skus: p.product_ids.map(id => products.find(prod => prod.id === id)?.sku).filter(s => s),
                    mechanics: p.details, start: p.start_date, end: p.end_date
                }));
            
            let channelContext = "";
            switch(selectedChannel) {
                case 'Tiktok Shop': channelContext = "M√¥ h√¨nh: Content-driven Commerce. ∆Øu ti√™n 'Deal h·ªùi ch·ªõp nho√°ng', Voucher Video v√† c√°c c√¥ng c·ª• Livestream nh∆∞ Comment-to-Buy."; break;
                case 'Shopee/Lazada': channelContext = "M√¥ h√¨nh: Marketplace Search. ∆Øu ti√™n Add-on Deals, Combo Bundle v√† Flash Sale s√†n."; break;
                case 'Website': channelContext = "M√¥ h√¨nh: DTC. ∆Øu ti√™n Membership Loyalty, Early Access v√† c√°c c∆° ch·∫ø Referral."; break;
                case 'Tiki': channelContext = "M√¥ h√¨nh: Fast Delivery. T·∫≠p trung giao nhanh 2h v√† c√°c ∆∞u ƒë√£i Member-Only Prices."; break;
                default: channelContext = "M√¥ h√¨nh: Omnichannel.";
            }

            const systemPrompt = `B·∫†N L√Ä: M·ªôt Gi√°m ƒë·ªëc TƒÉng tr∆∞·ªüng (Head of Growth) Ecommerce c·ªßa iBasic. 
            TH·ªúI ƒêI·ªÇM: Tu·∫ßn ${currentWeek}, Th√°ng ${currentMonth}.
            K√äNH M·ª§C TI√äU: ${selectedChannel}. B·ªêI C·∫¢NH: ${channelContext}
            
            D·ªÆ LI·ªÜU T·ªíN KHO & B√ÅN H√ÄNG (L7D): ${JSON.stringify(dataForAI)}.
            D·ªÆ LI·ªÜU KHUY·∫æN M√ÉI ƒêANG CH·∫†Y: ${JSON.stringify(activePromosForAI)}.
            
            QUY ∆Ø·ªöC GI√Å: C·ªôt 'list_price' trong d·ªØ li·ªáu l√† GI√Å NI√äM Y·∫æT (Gi√° tem). 
            
            NHI·ªÜM V·ª§: Ph√¢n t√≠ch h√†nh vi kh√°ch h√†ng v√† ƒë·ªÅ xu·∫•t chi·∫øn l∆∞·ª£c PUSH DOANH S·ªê cho k√™nh ${selectedChannel}.
            
            Y√äU C·∫¶U TR√åNH B√ÄY (CHUY√äN NGHI·ªÜP):
            - S·ª≠ d·ª•ng HTML v√† Tailwind CSS hi·ªán ƒë·∫°i.
            - Ph·∫ßn 1: Performance Matrix (Ph√¢n lo·∫°i Winner vs New Arrival vs Risk).
            - Ph·∫ßn 2: ƒê·ªÅ xu·∫•t Chi·∫øn l∆∞·ª£c Gi√° & Execution Tools (Ch·ªçn tools ph√π h·ª£p t·ª´ danh s√°ch 4 nh√≥m).
            - Ph·∫ßn 3: Growth Roadmap (Chi·∫øn d·ªãch c·ª• th·ªÉ theo tu·∫ßn cho ${selectedChannel}).
            - Ng√¥n ng·ªØ: Ti·∫øng Vi·ªát chuy√™n s√¢u v·ªÅ Ecommerce Fashion.
            - Ch·ªâ tr·∫£ v·ªÅ HTML trong 1 th·∫ª div. Kh√¥ng markdown.`;
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: systemPrompt }] }] })
                });
                const result = await response.json();
                const cleanHtml = result.candidates[0].content.parts[0].text.replace(/```html|```/g, '').trim();
                output.innerHTML = cleanHtml;
                showNotification(`ƒê√£ ph√¢n t√≠ch chi·∫øn l∆∞·ª£c cho k√™nh ${selectedChannel}`, "success");
            } catch (err) { 
                output.innerHTML = `<div class="text-center py-24 text-red-500"><i class="fas fa-exclamation-triangle text-5xl mb-4"></i><p class="font-black text-lg">L·ªñI PH√ÇN T√çCH AI</p></div>`; 
                showNotification("L·ªói AI Analysis", "error");
            } finally { 
                btn.disabled = false; btn.innerHTML = `<i class="fas fa-bolt mr-2"></i>GENERATE AI STRATEGY`; 
            }
        }

        // --- TAB & UI ---
        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.btn-tab').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            const btn = document.querySelector(`[onclick="switchTab('${id}')"]`);
            if(btn) btn.classList.add('active');
            if(id === 'calendar') renderWeeklyTimeline();
            if(id === 'dashboard') updateDashboard();
            if(id === 'promotions') renderPromotions();
            if(id === 'products') renderProducts();
        }

        // --- PRODUCT MGMT ---
        function renderProducts() {
            const tbody = document.getElementById('productsTableBody'); if (!tbody) return;
            const search = document.getElementById('searchProduct')?.value.toLowerCase() || "";
            const catVal = document.getElementById('filterCategory')?.value || "";
            const statVal = document.getElementById('filterStatus')?.value || "";
            const filtered = products.filter(p => 
                (p.sku.toLowerCase().includes(search) || p.name.toLowerCase().includes(search)) && 
                (!catVal || p.category === catVal) &&
                (!statVal || p.status === statVal)
            );
            tbody.innerHTML = filtered.map(p => `<tr class="hover:bg-pink-50 border-b last:border-0"><td class="px-4 py-3 font-mono text-blue-600 font-bold text-xs whitespace-normal break-all">${p.sku}</td><td class="px-4 py-3 text-xs font-medium whitespace-normal break-words">${p.name}</td><td class="px-4 py-3 text-center">${getStatusBadge(p.status)}</td><td class="px-4 py-3"><span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-[9px] font-bold uppercase">${p.category}</span></td><td class="px-4 py-3 text-right font-bold text-xs">${p.stock_quantity.toLocaleString()}</td><td class="px-4 py-3 text-right text-pink-600 font-bold text-xs">${p.sold_l7d.toLocaleString()}</td><td class="px-4 py-3 text-right text-xs font-bold">${p.unit_price.toLocaleString()}ƒë</td><td class="px-4 py-3 text-center space-x-2"><button onclick="editProduct(${p.id})" class="text-blue-500 p-1"><i class="fas fa-edit"></i></button><button onclick="confirmDeleteProduct(${p.id})" class="text-red-400 p-1"><i class="fas fa-trash-alt"></i></button></td></tr>`).join('');
            updateDashboard();
        }
        function openAddProductModal() { document.getElementById('addProductModal').classList.remove('hidden'); document.getElementById('addProductForm').reset(); document.getElementById('productIdToEdit').value = ''; updateCategoryUI(); }
        function closeAddProductModal() { document.getElementById('addProductModal').classList.add('hidden'); }
        function submitProduct(e) { e.preventDefault(); const f = new FormData(e.target); const id = document.getElementById('productIdToEdit').value; const data = { id: id ? parseInt(id) : Date.now(), sku: f.get('sku'), name: f.get('name'), status: f.get('status'), category: f.get('category').trim(), stock_quantity: parseInt(f.get('stock_quantity')), unit_price: parseInt(f.get('unit_price')), sold_l7d: id ? (products.find(p => p.id == id)?.sold_l7d || 0) : 0 }; if(id) products = products.map(p => p.id == id ? data : p); else products.push(data); saveData(); closeAddProductModal(); updateCategoryUI(); renderProducts(); showNotification("Product Saved!", "success"); }
        function editProduct(id) { const p = products.find(prod => prod.id === id); if(!p) return; openAddProductModal(); document.getElementById('productIdToEdit').value = p.id; const f = document.getElementById('addProductForm'); f.elements['name'].value = p.name; f.elements['sku'].value = p.sku; f.elements['status'].value = p.status; f.elements['category'].value = p.category; f.elements['stock_quantity'].value = p.stock_quantity; f.elements['unit_price'].value = p.unit_price; }

        function confirmDeleteProduct(id) { 
            showConfirmModal("Delete this SKU?", () => { 
                products = products.filter(p => p.id !== id); 
                saveData(); 
                updateCategoryUI(); 
                renderProducts(); 
            }); 
        }

        function confirmDeleteAllProducts() { 
            showConfirmModal("Delete ALL products?", () => { 
                products = []; 
                saveData(); 
                updateCategoryUI(); 
                renderProducts(); 
                showNotification("All products deleted", "info");
            }); 
        }

        // --- PROMOTION MANAGMENT ---
        function renderPromotions() {
            const tbody = document.getElementById('promotionsTableBody'); if(!tbody) return;
            const search = document.getElementById('promoFilterSearch')?.value.toLowerCase() || "";
            const tool = document.getElementById('promoFilterTool')?.value || "";
            const type = document.getElementById('promoFilterType')?.value || "";
            const status = document.getElementById('promoFilterStatus')?.value || "active";
            const filtered = promotions.filter(p => {
                const skus = p.product_ids.map(id => products.find(prod => prod.id === id)?.sku || '').join(' ').toLowerCase();
                const matchSearch = p.promotion_name.toLowerCase().includes(search) || skus.includes(search);
                const matchTool = !tool || p.promotion_tool === tool;
                const matchType = !type || p.promotion_type === type;
                const matchStatus = status === 'all' || (status === 'deleted' ? p.deleted : !p.deleted);
                return matchSearch && matchTool && matchType && matchStatus;
            });
            tbody.innerHTML = filtered.map(p => {
                const skuList = p.product_ids.map(id => products.find(prod => prod.id === id)?.sku).filter(s => s).join(', ');
                const isDeleted = p.deleted;
                return `<tr class="transition border-b last:border-0 ${isDeleted ? 'promo-deleted' : 'hover:bg-gray-50'}">
                    <td class="px-4 py-3"><div class="font-bold text-gray-800 text-xs whitespace-normal break-words">${p.promotion_name}</div></td>
                    <td class="px-4 py-3"><div class="text-[10px] text-gray-500 max-w-[200px] truncate" title="${skuList}">${skuList}</div><div class="text-[9px] text-pink-500 font-bold">${p.product_ids.length} SKU(s)</div></td>
                    <td class="px-4 py-3 text-center"><span class="px-2 py-1 rounded-full text-[9px] font-black uppercase text-white ${getPromoTypeClasses(p.promotion_type)}">${p.promotion_type}</span></td>
                    <td class="px-4 py-3 text-center text-[10px] text-gray-600">${p.promotion_tool}</td>
                    <td class="px-4 py-3 text-[10px] italic text-gray-500 max-w-[200px] break-words">${p.details || 'N/A'}</td>
                    <td class="px-4 py-3 text-[9px] text-gray-500 font-mono">${new Date(p.start_date).toLocaleDateString()} - ${new Date(p.end_date).toLocaleDateString()}</td>
                    <td class="px-4 py-3 text-center action-btns space-x-1">${isDeleted ? `<button onclick="restorePromo(${p.id})" class="text-green-500 p-1"><i class="fas fa-undo"></i></button>` : `<button onclick="editPromotion(${p.id})" class="text-blue-500 p-1"><i class="fas fa-edit"></i></button><button onclick="confirmDeletePromo(${p.id})" class="text-red-400 p-1"><i class="fas fa-trash-alt"></i></button>`}</td>
                </tr>`;
            }).join('');
        }

        // --- GLOBAL ACTIONS ---
        function confirmDeletePromo(id) { 
            showConfirmModal("Delete this promotion?", () => { 
                const p = promotions.find(item => item.id === id); 
                if(p) { p.deleted = true; saveData(); renderPromotions(); updateDashboard(); } 
            }); 
        }

        function restorePromo(id) { 
            const p = promotions.find(item => item.id === id); 
            if(p) { p.deleted = false; saveData(); renderPromotions(); updateDashboard(); } 
        }

        function confirmDeleteAllPromotions() { 
            showConfirmModal("Delete ALL campaigns?", () => { 
                promotions = []; 
                saveData(); 
                renderPromotions(); 
                updateDashboard(); 
            }); 
        }

        // --- UTILS ---
        function showNotification(msg, type = 'info') { 
            const c = document.getElementById('toastContainer'); const toast = document.createElement('div');
            const bg = type === 'success' ? 'bg-green-600' : (type === 'error' ? 'bg-red-600' : 'bg-pink-600');
            toast.className = `${bg} text-white px-6 py-3 rounded-xl shadow-2xl flex items-center transition-all duration-300 notification-toast`;
            toast.innerHTML = `<i class="fas fa-info-circle mr-3"></i><span class="text-xs font-bold">${msg}</span>`;
            c.prepend(toast); setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 3000);
        }
        function saveApiKey() { const k = document.getElementById('geminiApiKey').value.trim(); localStorage.setItem('ib_gemini_key', k); GEMINI_API_KEY = k; showNotification("API Key Saved Successfully", "success"); }
        
        function renderCharts() { 
            const ctx1 = document.getElementById('salesByCategoryChart'); if(!ctx1) return; if(sChart) sChart.destroy();
            const cats = getUniqueCategories(); const catUnits = cats.map(c => products.filter(p => p.category === c).reduce((s, p) => s + p.sold_l7d, 0));
            const totalUnits = catUnits.reduce((a, b) => a + b, 0);
            const labelsWithCont = cats.map((c, i) => { const pct = totalUnits > 0 ? ((catUnits[i] / totalUnits) * 100).toFixed(1) : 0; return `${c} (${pct}%)`; });
            sChart = new Chart(ctx1, { type: 'doughnut', data: { labels: labelsWithCont, datasets: [{ data: catUnits, backgroundColor: ['#ec4899', '#8b5cf6', '#f59e0b', '#10b981', '#3b82f6', '#64748b'] }] }, options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 10, weight: 'bold' } } } } } });
            
            const ctx2 = document.getElementById('stockVsSalesChart'); if(!ctx2) return; if(stChart) stChart.destroy();
            const top = [...products].sort((a,b) => b.sold_l7d - a.sold_l7d).slice(0, 10);
            stChart = new Chart(ctx2, { type: 'bar', data: { labels: top.map(p => p.sku), datasets: [{ label: 'Sold (L7D)', data: top.map(p => p.sold_l7d), backgroundColor: '#ec4899', borderRadius: 4 }] }, options: { maintainAspectRatio: false } });

            const ctx3 = document.getElementById('bottomSkusChart'); if(!ctx3) return; if(botChart) botChart.destroy();
            const bottom = [...products].sort((a,b) => a.sold_l7d - b.sold_l7d).slice(0, 10);
            botChart = new Chart(ctx3, { 
                type: 'bar', 
                data: { 
                    labels: bottom.map(p => p.sku), 
                    datasets: [{ 
                        label: 'Sold (L7D)', 
                        data: bottom.map(p => p.sold_l7d), 
                        backgroundColor: '#f97316', 
                        borderRadius: 4 
                    }] 
                }, 
                options: { 
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    }
                } 
            });
        }

        function exportProductsToExcel() { let csv = "\uFEFFSKU,Product Name,Status,Category,Stock,Price,Sold L7D\n"; products.forEach(p => csv += `"${p.sku}","${p.name}","${p.status}","${p.category}",${p.stock_quantity},${p.unit_price},${p.sold_l7d}\n`); const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = `iBasic_Inventory.csv`; link.click(); }
        
        function parseCleanNumber(val) {
            if (!val) return 0;
            const cleaned = val.toString().replace(/[^\d]/g, '');
            return parseInt(cleaned) || 0;
        }

        // --- UPDATED SMART CSV IMPORT ---
        function handleFileImport(e) { 
            const file = e.target.files[0]; 
            if(!file) return; 
            const r = new FileReader(); 
            r.onload = (ev) => { 
                const lines = ev.target.result.split(/\r?\n/); 
                for(let i = 1; i < lines.length; i++) { 
                    const line = lines[i].trim();
                    if(!line) continue;
                    
                    // Logic t√°ch c·ªôt th√¥ng minh: B·ªè qua d·∫•u ph·∫©y n·∫±m trong c·∫∑p ngo·∫∑c k√©p ""
                    const cols = [];
                    let startValueIndex = 0;
                    let inQuotes = false;
                    for (let j = 0; j < line.length; j++) {
                        if (line[j] === '"') inQuotes = !inQuotes;
                        if (line[j] === ',' && !inQuotes) {
                            cols.push(line.substring(startValueIndex, j).trim().replace(/^"|"$/g, '').replace(/""/g, '"'));
                            startValueIndex = j + 1;
                        }
                    }
                    // C·ªôt cu·ªëi c√πng
                    cols.push(line.substring(startValueIndex).trim().replace(/^"|"$/g, '').replace(/""/g, '"'));

                    if(cols.length >= 6) { 
                        const data = { 
                            id: Date.now() + i, 
                            sku: cols[0], 
                            name: cols[1], 
                            status: cols[2] || "Active", 
                            category: cols[3] || 'Uncategorized', 
                            stock_quantity: parseCleanNumber(cols[4]), 
                            unit_price: parseCleanNumber(cols[5]), 
                            sold_l7d: parseCleanNumber(cols[6]) 
                        }; 
                        const exIdx = products.findIndex(p => p.sku === data.sku); 
                        if(exIdx != -1) products[exIdx] = { ...products[exIdx], ...data }; 
                        else products.push(data); 
                    } 
                } 
                saveData(); 
                updateCategoryUI(); 
                renderProducts(); 
                showNotification("Import & Fix nh·∫£y c·ªôt th√†nh c√¥ng!", "success"); 
            }; 
            r.readAsText(file); 
        }

        function downloadSampleCSV() { const csv = "\uFEFFSKU,Product Name,Status,Category,Stock,Price,Sold L7D\nBRA-101,Comfort Bra,Active,Bra,100,250000,10"; const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = "ibasic_sample.csv"; link.click(); }

        // --- TIMELINE HELPERS ---
        function getWeekRange(weekNo, year) { const jan1 = new Date(year, 0, 1); const startOfFirstWeek = new Date(jan1); const dayOffset = jan1.getDay() === 0 ? -6 : 1 - jan1.getDay(); startOfFirstWeek.setDate(jan1.getDate() + dayOffset); const start = new Date(startOfFirstWeek); start.setDate(startOfFirstWeek.getDate() + (weekNo - 1) * 7); const end = new Date(start); end.setDate(start.getDate() + 6); return { start, end }; }
        function renderWeeklyTimeline() { const container = document.getElementById('calendarView'); if(!container) return; const year = parseInt(document.getElementById('timelineYearSelect').value); const startW = parseInt(document.getElementById('viewStartWeek').value); const endW = parseInt(document.getElementById('viewEndWeek').value); let html = ''; for (let w = startW; w <= endW; w++) { const { start, end } = getWeekRange(w, year); const activeInWeek = promotions.filter(p => !p.deleted && (new Date(p.start_date) <= end && new Date(p.end_date) >= start)); html += `<div class="projection-week"><div class="flex items-end justify-between mb-4 border-b border-gray-100 pb-2"><h3 class="text-lg font-black text-gray-800">Week ${w} <span class="text-[10px] text-gray-300 font-normal ml-2 uppercase tracking-tighter">${start.toLocaleDateString()} - ${end.toLocaleDateString()}</span></h3></div><div class="projection-grid shadow-sm rounded-xl overflow-hidden"><div class="projection-header">Project / Days</div>${[0,1,2,3,4,5,6].map(d => { const cur = new Date(start); cur.setDate(start.getDate() + d); const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']; return `<div class="projection-header bg-gray-50/50 day-col">${dayNames[d]}<br><span class="text-[8px] opacity-60">${cur.getDate()}/${cur.getMonth()+1}</span></div>`; }).join('')}${activeInWeek.length === 0 ? `<div class="col-span-8 py-10 text-center text-[10px] text-gray-300 italic">No Campaigns scheduled</div>` : activeInWeek.map(p => { const pStart = new Date(p.start_date); const pEnd = new Date(p.end_date); const startDayOnly = new Date(start); startDayOnly.setHours(0,0,0,0); let startDayOffset = Math.max(0, Math.floor((pStart.getTime() - startDayOnly.getTime()) / (24 * 60 * 60 * 1000))); let endDayOffset = Math.min(7, Math.ceil((pEnd.getTime() - startDayOnly.getTime()) / (24 * 60 * 60 * 1000))); if (pStart < start) startDayOffset = 0; if (pEnd > end) endDayOffset = 7; const leftPercent = (startDayOffset / 7) * 100; const widthPercent = ((endDayOffset - startDayOffset) / 7) * 100; return `<div class="projection-row col-span-8 flex items-center h-12"><div class="w-[140px] px-3 text-[9px] font-black truncate text-gray-500 border-r h-full flex items-center bg-gray-50/20">${p.promotion_name}</div><div class="flex-1 relative h-full"><div class="absolute inset-0 grid grid-cols-7 pointer-events-none">${[0,1,2,3,4,5,6].map(() => `<div class="border-r border-gray-100 h-full"></div>`).join('')}</div><div class="promo-bar ${getChannelColorClass(p.channel)}" style="left: ${leftPercent}%; width: ${widthPercent}%;" onclick="editPromotion(${p.id})"><div class="flex items-center space-x-1 truncate"><span class="font-black uppercase text-[7px] tracking-tighter">[${p.promotion_type}]</span><span class="truncate font-bold">${p.promotion_name}</span></div></div></div></div>`; }).join('')}</div></div>`; } container.innerHTML = html || `<div class="py-20 text-center text-gray-400">No data found</div>`; }

        // --- MODAL HELPERS ---
        function openAddPromotionModal() { document.getElementById('addPromotionModal').classList.remove('hidden'); document.getElementById('addPromotionForm').reset(); document.getElementById('promoIdToEdit').value = ''; loadCategoryCheckboxes(); loadNameGroupCheckboxes(); loadProductCheckboxes(); }
        function closeAddPromotionModal() { document.getElementById('addPromotionModal').classList.add('hidden'); }
        function loadCategoryCheckboxes() { const cats = getUniqueCategories(); document.getElementById('categoryCheckboxList').innerHTML = cats.map(c => `<label class="flex items-center p-1 hover:bg-pink-50 rounded cursor-pointer"><input type="checkbox" onchange="toggleCategorySkus('${c}', this.checked)" class="mr-2"><span class="text-[10px] font-bold text-gray-700 uppercase">${c}</span></label>`).join(''); }
        function loadNameGroupCheckboxes() { const names = [...new Set(products.map(p => p.name))].sort(); document.getElementById('nameGroupCheckboxList').innerHTML = names.map(name => `<label class="flex items-center p-1 hover:bg-blue-50 rounded cursor-pointer"><input type="checkbox" onchange="toggleNameSkus('${name.replace(/'/g, "\\'")}', this.checked)" class="mr-2"><span class="text-[9px] font-medium text-gray-700 truncate">${name}</span></label>`).join(''); }
        function loadProductCheckboxes() { document.getElementById('productCheckboxList').innerHTML = products.map(p => `<label class="flex items-center p-2 hover:bg-gray-100 rounded-lg cursor-pointer"><input type="checkbox" value="${p.id}" data-category="${p.category}" data-name="${p.name.replace(/'/g, "\\'")}" onchange="updateSelectedCount()" class="promo-sku-cb mr-2 rounded text-pink-500"><span class="text-[10px]"><b>${p.sku}</b> - ${p.name} <i class="text-[8px] text-gray-400">(${p.category})</i></span></label>`).join(''); }
        function toggleCategorySkus(catName, checked) { document.querySelectorAll(`.promo-sku-cb[data-category="${catName}"]`).forEach(cb => cb.checked = checked); updateSelectedCount(); }
        function toggleNameSkus(name, checked) { document.querySelectorAll(`.promo-sku-cb[data-name="${name.replace(/'/g, "\\'")}"]`).forEach(cb => cb.checked = checked); updateSelectedCount(); }
        function updateSelectedCount() { const count = document.querySelectorAll('.promo-sku-cb:checked').length; document.getElementById('selectedCount').textContent = `${count} Selected`; checkSkuOverlaps(); }
        function searchProductsInModal() { const f = document.getElementById('modalProductSearch').value.toLowerCase(); document.querySelectorAll('#productCheckboxList label').forEach(l => l.style.display = l.textContent.toLowerCase().includes(f) ? 'flex' : 'none'); }
        function searchNamesInModal() { const f = document.getElementById('modalNameSearch').value.toLowerCase(); document.querySelectorAll('#nameGroupCheckboxList label').forEach(l => l.style.display = l.textContent.toLowerCase().includes(f) ? 'flex' : 'none'); }
        function checkSkuOverlaps() { const selected = Array.from(document.querySelectorAll('.promo-sku-cb:checked')).map(cb => parseInt(cb.value)); const activeOverlaps = promotions.filter(p => !p.deleted && p.id != document.getElementById('promoIdToEdit').value && p.product_ids.some(id => selected.includes(id))); const box = document.getElementById('overlapAlertBox'); if (activeOverlaps.length > 0) { box.classList.remove('hidden'); document.getElementById('overlappingPromosList').innerHTML = activeOverlaps.map(p => `<div class="bg-white p-2 rounded border border-blue-100 text-[10px] flex justify-between"><b>${p.promotion_name}</b><span class="text-blue-600 font-bold">${p.promotion_type}</span></div>`).join(''); } else box.classList.add('hidden'); }
        
        function submitPromotion(e) { 
            e.preventDefault(); 
            const f = new FormData(e.target); 
            const id = f.get('promo_id'); 
            const selected = Array.from(document.querySelectorAll('.promo-sku-cb:checked')).map(cb => parseInt(cb.value)); 
            if(selected.length === 0) return showNotification("Please select at least one product!", "error"); 
            const data = { promotion_name: f.get('promotion_name'), product_ids: selected, promotion_type: f.get('promotion_type'), promotion_tool: f.get('promotion_tool'), start_date: f.get('start_date'), end_date: f.get('end_date'), channel: f.get('channel'), details: f.get('details'), deleted: false }; 
            if(id) { 
                const idx = promotions.findIndex(p => p.id == id); 
                const currentEditCount = promotions[idx].edit_count || 0; 
                promotions[idx] = { ...promotions[idx], ...data, edit_count: currentEditCount + 1 }; 
            } else { 
                promotions.push({ id: Date.now(), ...data, edit_count: 0 }); 
            } 
            saveData(); closeAddPromotionModal(); renderPromotions(); updateDashboard(); showNotification("Campaign Saved!", "success"); 
        }

        function editPromotion(id) { 
            const p = promotions.find(item => item.id === id); 
            if(!p) return; 
            openAddPromotionModal(); 
            document.getElementById('promoIdToEdit').value = p.id; 
            const f = document.getElementById('addPromotionForm'); 
            f.elements['promotion_name'].value = p.promotion_name; 
            f.elements['promotion_type'].value = p.promotion_type; 
            f.elements['promotion_tool'].value = p.promotion_tool; 
            f.elements['start_date'].value = p.start_date; 
            f.elements['end_date'].value = p.end_date; 
            f.elements['channel'].value = p.channel; 
            f.elements['details'].value = p.details; 
            setTimeout(() => { 
                document.querySelectorAll('.promo-sku-cb').forEach(cb => { cb.checked = p.product_ids.includes(parseInt(cb.value)); }); 
                updateSelectedCount(); 
            }, 50); 
        }
    </script>
</body>
</html>